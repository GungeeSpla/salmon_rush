let canvas,stage,isPlaying,startTime,currentFrame,salmonidId,lostSalmonidId,lostSalmonidCounts,popSalmonidCounts,updater,salmonids,goldenIkuras,debugs,ika,mapSizeX,mapSizeY,routeMapCache,rowWallStrs,colWallStrs,landStrs,walkableDirMap,ikuraContainerX,ikuraContainerY,xors,spawnDirs,currentSpawnDir,nextSpawnDirChangeFrame,spawnDirId,totalSalmonidsCount,goldenIkuraPopCount,goldenIkuraCount,deadEffects,attackX,attackY,selectMabikiRatio=0,specifiedSpawnDirs=[1,1,1,1,1,1,1,1,1,1],mabikiCells=[],inputValues={"seed-fix-checkbox":!1,"seed-fix-input":999,"auto-ikura-pickup-checkbox":!0,"auto-mabiki-checkbox":!1,"mabiki-cell-checkbox":!1,"spawn-dir-checkbox":!1,"ikura-pickup-seconds-input":4,"ikura-pickup-seconds-width-input":9,"auto-mabiki-shomen-checkbox":!1,"mabiki-shomen-ratio-input":80,"mabiki-shomen-speed-input":3,"auto-mabiki-migi-checkbox":!1,"mabiki-migi-ratio-input":80,"mabiki-migi-speed-input":3,"auto-mabiki-ura-checkbox":!1,"mabiki-ura-ratio-input":80,"mabiki-ura-speed-input":3};const COLOR_MABIKI="rgba(0, 100, 255, alpha)",COLOR_BG="#FFFFFF",COLOR_WALL="#000000",COLOR_GOLDIE="#FFCC00",COLOR_CHUM="#FF4400",COLOR_SNATCHER="#8800CC",COLOR_STROKE="#000000",COLOR_GOLDEN_IKURA="#FFFFCC",MARGIN_X=40,MARGIN_Y=40,CELL_SIZE=40,CANVAS_ID="createjs-canvas",CANVAS_WIDTH=520,CANVAS_HEIGHT=640,IS_ENABLED_STAGEGL=!1,SHOULD_USE_TIMEOUT=!0,CLEAR_COLOR="White",FRAME_RATE=60,REDRAW_RATE=2,STAGE_UPDATE=!0,SALMONID_INTERVAL=Math.floor(FRAME_RATE/6),GOLDIE_CYCLE=20,GOLDIE_LIFE=500,GOLDIE_HIT_IKURA=12,GOLDIE_KILL_IKURA=6,GOLDIE_GOLDEN_IKURA=3,GOLDIE_NUM_MAX=8,SNATCHER_LIFE=100,SNATCHER_HIT_IKURA=3,SNATCHER_KILL_IKURA=3,CHUM_LIFE=50,CHUM_HIT_IKURA=3,CHUM_KILL_IKURA=2,ACTIVE_MAX=32,WAVE_SECONDS=100,WAVE_FRAMES=100*FRAME_RATE,MAP_DATA_WALL_ROW="\n　　　　　　　━　━　\n　　　　　　　　　　　\n　　　　　　　　　　　\n　　　　━━　　　　　\n　　━━　　━　━　━\n　　　━━━━┻━　　\n　　　━┻━━━　　　\n　━　　　┻━　　　━\n━　　　　　　　　　　\n　　　　　　　　　　　\n　　　　　━┳━━　　\n　　　　━┳┳━━━　\n　　　　　　　　━　　\n━　　　　　　━　　　\n　━━━━━━　　　　",MAP_DATA_WALL_COL="\n　　　　　　　┃┃┃┃　\n　　　　　　　┃┃┃┃　\n　　　　　　　┃┃┃┃　\n　　　　┃　┃┃┃┃┃　\n　　┃　　　　　　　　┃\n　　┃　　　　　　┃　┃\n　　┃┃　　　　┃┣　┃\n　┃　┃┃┃　　┣┃┃　\n┃　　┃┃　　　┃┣┃　\n┃　　┫┫┃　　　┃┃　\n┃　　┃┃　　　　　┃　\n┃　　　　　　　　┃　　\n┃　　　　　　　┃　　　\n　┃　　　　　┃　　　　",MAP_DATA_LAND="\n□□□□□□□Ａ□Ｂ□\n□□□□□□□■□■□\n□□□□□□□■□■□\n□□□□ＡＡ□■□■□\n□□■■■■■■■■Ｂ\n□□■■■■■■■■Ｂ\n□□■■■■■■■■Ｂ\n□■■■■■■■■■□\nＣ■■■■■★■■■□\nＣ■■■■■■■■■□\nＣ■■■■■■■■■□\nＣ■■■■■■■Ｃ□□\nＣ■■■■■■Ｃ□□□\n□ＣＣＣＣＣＣ□□□□",MOVE_UNIT=.42/FRAME_RATE,LAST_SPAWN_SECONDS=28,SNATCHER_SPEED=1.5,GOLDIE_SPEED=3.5,CHUM_SPEED=3.5,SNATCHER_INTERVAL=Math.floor(FRAME_RATE/10),SNATCHER_WAITING_FRAME=Math.floor(3.5*FRAME_RATE),SNATCHER_PICKUP_FRAME=Math.floor(4*FRAME_RATE),SPAWN_DIR_CHANGE_COUNT=7,SPAWN_DIR_CHANGE_SECONDS=[10,20,30,41,51,61,72,82,92],SPAWN_DIR_CHANGE_FRAMES=(()=>{const e=[];return SPAWN_DIR_CHANGE_SECONDS.forEach(t=>{e.push(t*FRAME_RATE)}),e})(),SPAWN_POINTS=[],SPAWN_DIRS=[{name:"shomen",str:"Ａ",weight:40,points:[]},{name:"migi",str:"Ｂ",weight:35,points:[]},{name:"ura",str:"Ｃ",weight:25,points:[]}],DIRS=[[0,-1],[1,0],[0,1],[-1,0]],AROUNDS=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],NORM_DIST_MAX=982,NORM_DIST_ARRAY=[1,2,3,5,6,8,10,12,15,17,20,24,27,31,35,40,45,50,56,62,69,76,83,91,100,109,119,129,139,151,162,175,188,201,215,230,244,260,276,292,309,326,344,361,380,398,416,435,454,473,492,511,530,549,568,586,604,623,640,658,675,692,708,724,740,754,769,783,796,809,822,833,845,855,865,875,884,893,901,908,915,922,928,934,939,944,949,953,957,960,964,967,969,972,974,976,978,979,981,982],AVG_PICKUP_SECONDS=3.5,MABIKI_SECONDS=3.5,MABIKI_SECONDS_WIDTH=1.5,MABIKI_RATIO=.5,GAME_SPEED=1,FIXED_SEED=100,FIXED_SPAWN_DIRS=[1,1,1,1,1,1,0,1,1,1];function random(){return xors.getRandom(100)/100}function normalRandom(e=0,t=.99){const i=Math.floor(100*e),s=Math.floor(100*t),a=NORM_DIST_ARRAY[i],n=NORM_DIST_ARRAY[s]-a,o=a+xors.getRandom(n);for(let e=i;e<NORM_DIST_ARRAY.length;e+=1)if(o<NORM_DIST_ARRAY[e])return e/100}Array.prototype.shuffle=function(){let e,t,i;for(e=this.length;e;)t=Math.floor(random()*e),i=this[e-=1],this[e]=this[t],this[t]=i;return this};class Xors{constructor(e){this.x=123456789,this.y=362436069,this.z=521288629,this.w=e||88675123}random(){const e=this.x^this.x<<11;return this.x=this.y,this.y=this.z,this.z=this.w,this.w=this.w^this.w>>19^e^e>>8,this.w}getRandom(e){return this.random()%e}}function createMapData(){const e=e=>{let t=e.split("\n");const i=[];for(let e=0,s=0;e<t.length;e+=1){const a=t[e];if(a.length>0){i[s]=[];for(let e=0;e<a.length;e+=1)i[s][e]=a.charAt(e);s+=1}}return i},t=e=>{const t=[];for(let i=0;i<mapSizeY;i+=1){t[i]=[];for(let s=0;s<mapSizeX;s+=1)t[i][s]=e}return t};rowWallStrs=e(MAP_DATA_WALL_ROW),colWallStrs=e(MAP_DATA_WALL_COL),landStrs=e(MAP_DATA_LAND),mapSizeY=landStrs.length,mapSizeX=landStrs[0].length,routeMapCache=t(null),walkableDirMap=t(null),(e=>{for(let t=0;t<mapSizeY;t+=1)for(let i=0;i<mapSizeX;i+=1)e(i,t)})((e,t)=>{walkableDirMap[t][e]=[0,0,0,0],"★"===landStrs[t][e]&&(ikuraContainerX=e,ikuraContainerY=t);let i=!1;SPAWN_DIRS.forEach(s=>{s.str.indexOf(landStrs[t][e])>-1&&(i=!0,s.points.push({x:e,y:t}))}),i&&SPAWN_POINTS.push({x:e,y:t}),"□"!==landStrs[t][e]&&("　"!==rowWallStrs[t][e]&&"┻"!==rowWallStrs[t][e]||(walkableDirMap[t][e][0]=1),"　"!==colWallStrs[t][e+1]&&"┣"!==colWallStrs[t][e+1]||(walkableDirMap[t][e][1]=1),"　"!==rowWallStrs[t+1][e]&&"┳"!==rowWallStrs[t+1][e]||(walkableDirMap[t][e][2]=1),"　"!==colWallStrs[t][e]&&"┫"!==colWallStrs[t][e]||(walkableDirMap[t][e][3]=1))})}function runRecursive(e,...t){const i={lastReturnValue:null},s=[];for(s.push({iterator:e(...t),lastReturnValue:null,caller:i});s.length>0;){const t=s[s.length-1],{iterator:i,lastReturnValue:a,caller:n}=t,{value:o,done:r}=i.next(a);r?(n.lastReturnValue=o,s.pop()):s.push({iterator:e(...o),lastReturnValue:null,caller:t})}return i.lastReturnValue}function*search(e,t,i,s,a,n){if(!(s[t][e].distance>-1&&s[t][e].distance<i)){s[t][e].distance=i,s[t][e].connectX=a,s[t][e].connectY=n;for(let a=0;a<DIRS.length;a+=1){const n=e+DIRS[a][0],o=t+DIRS[a][1];n<0||o<0||n>=mapSizeX||o>=mapSizeY||walkableDirMap[o][n][(a+2)%4]&&(yield[n,o,i+1,s,e,t])}}}function createRouteMap(e,t){const i=[];for(let e=0;e<mapSizeY;e+=1){i[e]=[];for(let t=0;t<mapSizeX;t+=1)i[e][t]={distance:-1,connectX:-1,connectY:-1}}return runRecursive(search,e,t,0,i,null,null),i}function getRouteMap(e,t){return routeMapCache[t][e]||(routeMapCache[t][e]=createRouteMap(e,t)),routeMapCache[t][e]}class Salmonid{constructor(e,t){this.x=e,this.y=t,this.tx=0,this.ty=0,this.dx=0,this.dy=0,this.bookingX=-1,this.bookingY=-1,this.speed=1,this.routeMap=null,this.sprite=null,this.frame=0,this.life=1}createGraphics(){const e=new createjs.Shape;e.alpha=1,e.graphics.beginStroke(COLOR_STROKE),e.graphics.setStrokeStyle(1),e.graphics.beginFill(this.color),e.graphics.drawCircle(0,0,this.radius),e.cache(-CELL_SIZE/2,-CELL_SIZE/2,CELL_SIZE,CELL_SIZE),stage.addChild(e),this.sprite=e}setXY(e,t){this.x=e,this.y=t,this.sprite.x=(this.x+this.tx*this.dx)*CELL_SIZE+MARGIN_X+CELL_SIZE/2,this.sprite.y=(this.y+this.ty*this.dy)*CELL_SIZE+MARGIN_Y+CELL_SIZE/2}bookingRouteMap(e,t){0===this.dx&&0===this.dy?this.setRouteMap(e,t):(this.bookingX=e,this.bookingY=t)}setRouteMap(e,t){this.routeMap=getRouteMap(e,t),this.routeMap[this.y][this.x].distance>0?(this.dx=this.routeMap[this.y][this.x].connectX-this.x,this.dy=this.routeMap[this.y][this.x].connectY-this.y):(this.dx=0,this.dy=0)}update(){this.move()}move(){const e=0===this.dx?0:this.speed*MOVE_UNIT,t=0===this.dy?0:this.speed*MOVE_UNIT;this.tx+=e,this.ty+=t;let i=-1;this.tx>=1?(i=this.tx-1,this.tx=1):this.ty>=1&&(i=this.ty-1,this.ty=1),i>-1&&(this.x+=this.dx,this.y+=this.dy,this.bookingX>-1&&(this.setRouteMap(this.bookingX,this.bookingY),this.bookingX=-1,this.bookingY=-1,i=0),this.tx=i,this.ty=i,this.dx=0,this.dy=0,this.routeMap[this.y][this.x].distance>0?(this.dx=this.routeMap[this.y][this.x].connectX-this.x,this.dy=this.routeMap[this.y][this.x].connectY-this.y):this.reachGoal()),this.sprite.x=(this.x+this.tx*this.dx)*CELL_SIZE+MARGIN_X+CELL_SIZE/2,this.sprite.y=(this.y+this.ty*this.dy)*CELL_SIZE+MARGIN_Y+CELL_SIZE/2}reachGoal(){}receiveDamage(e){this.life=Math.max(0,this.life-e),0===this.life&&this.die()}die(){this.pushDeadEffect(),this.remove()}pushDeadEffect(){pushDeadEffect({x:this.sprite.x,y:this.sprite.y,color:this.color,radius:this.radius})}remove(){stage.removeChild(this.sprite);const e=salmonids.indexOf(this);e>-1&&salmonids.splice(e,1)}test(){console.log("Salmonid Test")}}class Goldie extends Salmonid{constructor(e,t){super(e,t),this.life=GOLDIE_LIFE,this.name="Goldie",this.speed=GOLDIE_SPEED,this.color=COLOR_GOLDIE,this.radius=CELL_SIZE/3,this.createGraphics(),this.setXY(e,t),this.setRouteMap(ikuraContainerX,ikuraContainerY)}reachGoal(){this.receiveDamage(GOLDIE_LIFE)}die(){const e=[];if(AROUNDS.forEach(t=>{const i=this.x+t[0],s=this.y+t[1];"■"===landStrs[s][i]&&e.push({x:i,y:s})}),e.length>0){e.shuffle();for(let t=0;t<GOLDIE_GOLDEN_IKURA;t+=1){const i=e[t%e.length];new GoldenIkura(i.x,i.y),goldenIkuraPopCount+=1}}super.die()}test(){super.test(),console.log("Goldie Test")}}class Chum extends Salmonid{constructor(e,t){if(super(e,t),this.life=CHUM_LIFE,this.name="Chum",this.speed=CHUM_SPEED,this.color=COLOR_CHUM,this.radius=CELL_SIZE/6,this.isJudgedMabiki=!1,this.createGraphics(),this.setXY(e,t),this.setRouteMap(ikuraContainerX,ikuraContainerY),this.deadFrame=-1,inputValues["auto-mabiki-checkbox"]&&inputValues[`auto-mabiki-${currentSpawnDir.name}-checkbox`]){const e=inputValues[`mabiki-${currentSpawnDir.name}-ratio-input`];if(random()<e/100){const e=inputValues[`mabiki-${currentSpawnDir.name}-speed-input`],t=0;this.deadFrame=currentFrame+Math.floor((e+t)*FRAME_RATE)}}}update(){super.update(),this.life>0&&(currentFrame===this.deadFrame?this.receiveDamage(CHUM_LIFE):attackX>-1&&this.x===attackX&&this.y===attackY?this.receiveDamage(CHUM_LIFE):!this.isJudgedMabiki&&inputValues["mabiki-cell-checkbox"]&&mabikiCells.forEach(e=>{this.x===e.x&&this.y===e.y&&(this.isJudgedMabiki=!0,random()<e.ratio/100&&this.receiveDamage(CHUM_LIFE))}))}reachGoal(){this.receiveDamage(CHUM_LIFE)}}class Snatcher extends Salmonid{constructor(e,t,i){super(e,t),this.name="Snatcher",this.speed=SNATCHER_SPEED,this.targetIkuraExists=!0,this.color=COLOR_SNATCHER,this.radius=CELL_SIZE/6,this.createGraphics(),this.sprite.alpha=0,this.options={x:e,y:t},this.goldenIkura=i,this.sleep(),this.sprite.on("click",()=>{this.receiveDamage(100)})}gotosea(){if(this.isWaiting)return void this.remove();let e,t=9999;SPAWN_POINTS.forEach(i=>{const s=getRouteMap(i.x,i.y)[this.y][this.x].distance;s<t&&(t=s,e=i)}),this.bookingRouteMap(e.x,e.y),this.reachGoal=this.reachSea}sleep(){this.life=SNATCHER_LIFE,this.setXY(this.options.x,this.options.y),this.setRouteMap(this.goldenIkura.x,this.goldenIkura.y),this.frame=0,this.isSleeping=!0,this.isWaiting=!0,this.didReachedGoldenIkura=!1,this.hasGoldenIkura=!1,this.sprite.alpha=0,this.reachGoal=this.reachGoldenIkura}wakeup(){this.isSleeping=!1}depart(){this.isWaiting=!1,this.sprite.alpha=1}update(){this.isSleeping||(this.isWaiting?this.frame===SNATCHER_WAITING_FRAME&&this.depart():(this.move(),this.hasGoldenIkura&&(this.goldenIkura.x=this.x,this.goldenIkura.y=this.y,this.goldenIkura.sprite.x=(this.x+this.tx*this.dx)*CELL_SIZE+MARGIN_X,this.goldenIkura.sprite.y=(this.y+this.ty*this.dy)*CELL_SIZE+MARGIN_Y),this.didReachedGoldenIkura&&this.frame===SNATCHER_PICKUP_FRAME&&this.pickup()),this.frame+=1)}pickup(){this.hasGoldenIkura=!0,this.gotosea()}reachGoldenIkura(){this.didReachedGoldenIkura=!0,this.frame=0}reachSea(){this.remove(),this.hasGoldenIkura&&this.goldenIkura.remove()}die(){this.hasGoldenIkura?(this.goldenIkura.x=this.x,this.goldenIkura.y=this.y,this.goldenIkura.sprite.x=this.x*CELL_SIZE+MARGIN_X,this.goldenIkura.sprite.y=this.y*CELL_SIZE+MARGIN_Y,this.pushDeadEffect(),this.sleep()):this.goldenIkura.isOnGround?(this.pushDeadEffect(),this.sleep()):(this.pushDeadEffect(),this.remove())}}class GoldenIkura{constructor(e,t){const i=new createjs.Shape;i.graphics.beginStroke(COLOR_STROKE),i.graphics.setStrokeStyle(1),i.graphics.beginFill(COLOR_STROKE),i.graphics.drawCircle(CELL_SIZE/2,CELL_SIZE/2,CELL_SIZE/2);const s=new createjs.Shape;if(s.graphics.beginStroke(COLOR_STROKE),s.graphics.setStrokeStyle(1),s.graphics.beginFill(COLOR_GOLDEN_IKURA),s.graphics.drawCircle(CELL_SIZE/2,CELL_SIZE/2,CELL_SIZE/4),s.hitArea=i,s.cursor="pointer",stage.addChild(s),this.sprite=s,this.setXY(e,t),this.pickupFrame=-1,this.isOnGround=!0,goldenIkuras.push(this),this.createSnatcher(),this.sprite.on("click",()=>{this.pickup()}),inputValues["auto-ikura-pickup-checkbox"]){const e=inputValues["ikura-pickup-seconds-input"],t=1,i=inputValues["ikura-pickup-seconds-width-input"];let s=0;Math.min(i,e-t);if(e-t<i){s=(1-(e-t)/i)/2}const a=e+i*(2*normalRandom(s)-1);this.pickupFrame=currentFrame+Math.floor(a*FRAME_RATE)}}update(){currentFrame===this.pickupFrame&&this.isOnGround&&this.pickup()}pickup(){goldenIkuraCount+=1,this.isOnGround=!1,this.remove(),this.snatcher&&this.snatcher.gotosea()}createSnatcher(){let e,t=9999;const i=getRouteMap(this.x,this.y);SPAWN_POINTS.forEach(s=>{const a=i[s.y][s.x].distance;a<t&&(t=a,e=s)}),this.snatcher=new Snatcher(e.x,e.y,this),salmonids.push(this.snatcher)}setXY(e,t){this.x=e,this.y=t,this.sprite.x=(this.x+.8*(random()-.5))*CELL_SIZE+MARGIN_X,this.sprite.y=(this.y+.8*(random()-.5))*CELL_SIZE+MARGIN_Y}remove(){stage.removeChild(this.sprite);const e=goldenIkuras.indexOf(this);e>-1&&goldenIkuras.splice(e,1)}}function wakeupSnatcher(){if(!(totalSalmonidsCount>=ACTIVE_MAX))for(let e=0;e<salmonids.length;e+=1)if("Snatcher"===salmonids[e].name&&salmonids[e].isSleeping){salmonids[e].wakeup();break}}function createSalmonid(){if(totalSalmonidsCount>=ACTIVE_MAX)return lostSalmonidId%GOLDIE_CYCLE==0?lostSalmonidCounts.Goldie+=1:lostSalmonidCounts.Chum+=1,void(lostSalmonidId+=1);let e;salmonidId+=1;const t=xors.getRandom(currentSpawnDir.points.length),i=currentSpawnDir.points[t];salmonidId%GOLDIE_CYCLE==0?(e=new Goldie(i.x,i.y),popSalmonidCounts.Goldie+=1):(e=new Chum(i.x,i.y),popSalmonidCounts.Chum+=1),salmonids.push(e)}function finishGame(){let e;for(isPlaying=!1,updater=(()=>{});goldenIkuras&&goldenIkuras[0]&&goldenIkuras[0]!==e;)e=goldenIkuras[0],goldenIkuras[0].remove();for(;salmonids&&salmonids[0]&&salmonids[0]!==e;)e=salmonids[0],salmonids[0].remove();for(;deadEffects&&deadEffects[0]&&deadEffects[0]!==e;)e=deadEffects[0],deadEffects.shift(),stage.removeChild(e);stage.update()}function createSpawnDirs(){spawnDirs=[];const e=SPAWN_DIR_CHANGE_FRAMES.length+1;for(let t=0;t<e;t+=1){let e=0;SPAWN_DIRS.forEach(t=>{e+=t.weight});let i=xors.getRandom(e),s=SPAWN_DIRS[0];for(let e=0;e<SPAWN_DIRS.length;e+=1){if(i<SPAWN_DIRS[e].weight){s=SPAWN_DIRS[e];break}i-=SPAWN_DIRS[e].weight}inputValues["spawn-dir-checkbox"]&&(s=SPAWN_DIRS[specifiedSpawnDirs[t]]),spawnDirs.push(s)}}function gameUpdater(){const e=Math.max(0,Math.ceil((WAVE_FRAMES-currentFrame)/FRAME_RATE));totalSalmonidsCount=0;const t={Goldie:0,Chum:0,Snatcher:0};for(let e=0;e<salmonids.length;e+=1){const i=salmonids[e].name;i in t?"Snatcher"===i?!salmonids[e].isSleeping&&salmonids[e].life>0&&(t[i]+=1,totalSalmonidsCount+=1):salmonids[e].life>0&&(t[i]+=1,totalSalmonidsCount+=1):salmonids[e].life>0&&(t[i]=1,totalSalmonidsCount+=1)}for(let e=salmonids.length-1;e>=0;e-=1)salmonids[e].update();for(let e=goldenIkuras.length-1;e>=0;e-=1)goldenIkuras[e].update();for(let e=deadEffects.length-1;e>=0;e-=1){const t=deadEffects[e];t.frame+=1,t.scale=1+2*t.frame/15,t.alpha=1-t.frame/15,t.frame>=15&&(stage.removeChild(t),deadEffects.splice(e,1),e-=1)}debugs["info-left-seconds"].textContent=e,debugs["info-pop-golden-egg-counts"].textContent=goldenIkuraPopCount,debugs["info-golden-egg-counts"].textContent=goldenIkuraCount,debugs["info-salmonid-counts"].textContent=`(キ) ${t.Goldie} / (シ) ${t.Chum} / (タ) ${t.Snatcher}`,debugs["info-pop-salmonid-counts"].textContent=`(キ) ${popSalmonidCounts.Goldie} / (シ) ${popSalmonidCounts.Chum}`,debugs["info-lost-salmonid-counts"].textContent=`(キ) ${lostSalmonidCounts.Goldie} / (シ) ${lostSalmonidCounts.Chum}`,currentFrame%SALMONID_INTERVAL==0&&t.Goldie<GOLDIE_NUM_MAX&&createSalmonid(),currentFrame%SNATCHER_INTERVAL==0&&wakeupSnatcher(),currentFrame==SPAWN_DIR_CHANGE_FRAMES[spawnDirId]&&(currentSpawnDir=spawnDirs[spawnDirId+=1]),currentFrame>=WAVE_FRAMES&&finishGame(),currentFrame+=1,STAGE_UPDATE&&currentFrame%(REDRAW_RATE*GAME_SPEED)==0&&stage.update()}function pushDeadEffect(e){const t=new createjs.Shape;t.alpha=1,t.x=e.x,t.y=e.y,t.graphics.beginFill(e.color),t.graphics.drawCircle(0,0,e.radius),t.cache(-CELL_SIZE/2,-CELL_SIZE/2,CELL_SIZE,CELL_SIZE),stage.addChild(t),t.frame=0,deadEffects.push(t)}function startGame(){createjs.Ticker.reset(),createjs.Ticker.on("tick",()=>{updater()}),createjs.Ticker.isPaused=!1,finishGame(),isPlaying=!0,attackX=-1,attackY=-1,goldenIkuraCount=0,goldenIkuraPopCount=0,spawnDirId=0,salmonidId=0,lostSalmonidId=0,lostSalmonidCounts={Goldie:0,Chum:0},popSalmonidCounts={Goldie:0,Chum:0},currentFrame=0,nextSpawnDirChangeFrame=SPAWN_DIR_CHANGE_FRAMES[0],deadEffects=[],salmonids=[],goldenIkuras=[],startTime=(new Date).getTime(),updater=gameUpdater;const e=inputValues["seed-fix-checkbox"]>0?Math.max(0,inputValues["seed-fix-input"]):Math.floor(startTime);xors=new Xors(e),createSpawnDirs(),currentSpawnDir=spawnDirs[0]}const STORAGE_KEY="salmon_rush";function save(){const e={inputValues:inputValues,specifiedSpawnDirs:specifiedSpawnDirs,mabikiCells:mabikiCells},t=JSON.stringify(e);localStorage.setItem(STORAGE_KEY,t)}function load(){const e=localStorage.getItem(STORAGE_KEY);if(null!==e){const t=JSON.parse(e);"inputValues"in t&&Object.keys(t.inputValues).forEach(e=>{inputValues[e]=t.inputValues[e]}),"specifiedSpawnDirs"in t&&(specifiedSpawnDirs=t.specifiedSpawnDirs),"mabikiCells"in t&&(mabikiCells=t.mabikiCells)}Object.keys(inputValues).forEach(e=>{e.indexOf("checkbox")>-1?document.getElementById(e).checked=inputValues[e]:document.getElementById(e).value=inputValues[e]});for(let e=1;e<=10;e+=1){document.getElementsByName(`spawn-dir-${e}`)[specifiedSpawnDirs[e-1]].checked=!0}}function setEvents(){load(),document.getElementById("start-button").addEventListener("click",e=>{startGame()}),document.getElementById("pause-button").addEventListener("click",function(e){createjs.Ticker.isPaused?(isPlaying=!0,createjs.Ticker.isPaused=!1,createjs.Ticker.on("tick",updater),this.textContent="一時停止"):(isPlaying=!1,createjs.Ticker.isPaused=!0,createjs.Ticker.reset(),this.textContent="再開")}),document.getElementById("stop-button").addEventListener("click",e=>{finishGame()});const e=document.getElementsByClassName("checkbox-input");Array.prototype.forEach.call(e,e=>{e.addEventListener("change",t=>{const i=e.checked;inputValues[e.id]=i,save()})});const t=document.getElementsByClassName("number-input");Array.prototype.forEach.call(t,e=>{e.addEventListener("change",t=>{let i=parseFloat(e.value);isNaN(i)?e.classList.add("error"):("-1"!=e.getAttribute("max")&&(i=Math.max(0,Math.min(100,i))),e.classList.remove("error"),inputValues[e.id]=i,save(),e.value=i)})}),["auto-mabiki-checkbox","mabiki-cell-checkbox","spawn-dir-checkbox","auto-ikura-pickup-checkbox","seed-fix-checkbox"].forEach(e=>{const t=document.getElementById(e),i=()=>{const i=t.checked?"block":"none";document.getElementById(`${e}-content`).style.setProperty("display",i)};t.addEventListener("change",i),i(),"mabiki-cell-checkbox"===e&&t.addEventListener("change",drawMap)});const i=document.querySelectorAll(".mabiki-table td");Array.prototype.forEach.call(i,e=>{e.addEventListener("click",t=>{const i=parseInt(e.textContent),s=document.getElementsByClassName("mabiki-select")[0];s.textContent=i,s.style.setProperty("background",COLOR_MABIKI.replace("alpha",i/100)),selectMabikiRatio=i})}),document.getElementById("mabiki-reset-button").addEventListener("click",e=>{for(console.log("間引きマスをリセットしました");mabikiCells[0];)mabikiCells.pop();drawMap()});const s=document.getElementById("spawn-dir-table").querySelectorAll("input[type=radio]");Array.prototype.forEach.call(s,e=>{"spawn-dir-0"===e.name?e.addEventListener("change",t=>{parseInt(e.name.replace("spawn-dir-",""));const i=e.value;let s=0;for(let e=0;e<SPAWN_DIRS.length;e+=1)if(SPAWN_DIRS[e].name===i){s=e;break}for(let e=1;e<=10;e+=1){document.getElementsByName(`spawn-dir-${e}`)[s].checked=!0,specifiedSpawnDirs[e-1]=s}save()}):e.addEventListener("change",t=>{const i=parseInt(e.name.replace("spawn-dir-","")),s=e.value;let a=0;for(let e=0;e<SPAWN_DIRS.length;e+=1)if(SPAWN_DIRS[e].name===s){a=e;break}specifiedSpawnDirs[i-1]=a,save()})})}let mapSprite;function drawMap(){mapSprite?mapSprite.graphics.clear():(mapSprite=new createjs.Shape,stage.addChild(mapSprite)),mapSprite.graphics.beginFill(COLOR_BG).rect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);for(let e=0;e<rowWallStrs.length;e+=1)for(let t=0;t<rowWallStrs[0].length;t+=1)"　"!==rowWallStrs[e][t]&&mapSprite.graphics.beginStroke(COLOR_WALL).moveTo(MARGIN_X+(t+0)*CELL_SIZE,MARGIN_Y+(e+0)*CELL_SIZE).lineTo(MARGIN_X+(t+1)*CELL_SIZE,MARGIN_Y+(e+0)*CELL_SIZE).endStroke();for(let e=0;e<colWallStrs.length;e+=1)for(let t=0;t<colWallStrs[0].length;t+=1)"　"!==colWallStrs[e][t]&&mapSprite.graphics.beginStroke(COLOR_WALL).moveTo(MARGIN_X+(t+0)*CELL_SIZE,MARGIN_Y+(e+0)*CELL_SIZE).lineTo(MARGIN_X+(t+0)*CELL_SIZE,MARGIN_Y+(e+1)*CELL_SIZE).endStroke();inputValues["mabiki-cell-checkbox"]&&mabikiCells.forEach(e=>{mapSprite.graphics.beginFill(COLOR_MABIKI.replace("alpha",e.ratio/100)).rect(MARGIN_X+(e.x+0)*CELL_SIZE,MARGIN_Y+(e.y+0)*CELL_SIZE,CELL_SIZE-1,CELL_SIZE-1)}),mapSprite.cache(0,0,CANVAS_WIDTH,CANVAS_HEIGHT),stage.update()}function initialize(){setEvents(),createMapData(),createjs=window.createjs,(canvas=document.getElementById(CANVAS_ID)).width=CANVAS_WIDTH,canvas.height=CANVAS_HEIGHT;const e=document.getElementById("canvas-wrapper");e.style.setProperty("width",CANVAS_WIDTH+"px"),e.style.setProperty("height",CANVAS_HEIGHT+"px"),IS_ENABLED_STAGEGL?(stage=new createjs.StageGL(canvas)).setClearColor(CLEAR_COLOR):stage=new createjs.Stage(canvas),canvas.stage=stage,stage.enableMouseOver(),createjs.Touch.isSupported()&&createjs.Touch.enable(stage),SHOULD_USE_TIMEOUT?(createjs.Ticker.timingMode=createjs.Ticker.TIMEOUT,createjs.Ticker.framerate=FRAME_RATE*GAME_SPEED):FRAME_RATE>=60?createjs.Ticker.timingMode=createjs.Ticker.RAF:(createjs.Ticker.timingMode=createjs.Ticker.RAF_SYNCHED,createjs.Ticker.framerate=FRAME_RATE),updater=(()=>{}),drawMap(),mapSprite.on("mousedown",e=>{const t=stage.mouseX-MARGIN_X,i=stage.mouseY-MARGIN_Y,s=Math.floor(t/CELL_SIZE),a=Math.floor(i/CELL_SIZE);s>=0&&s<mapSizeX&&a>=0&&a<mapSizeY&&(attackX=s,attackY=a)}),mapSprite.on("pressmove",e=>{const t=stage.mouseX-MARGIN_X,i=stage.mouseY-MARGIN_Y,s=Math.floor(t/CELL_SIZE),a=Math.floor(i/CELL_SIZE);s>=0&&s<mapSizeX&&a>=0&&a<mapSizeY&&(attackX=s,attackY=a)}),mapSprite.on("pressup",e=>{attackX=-1,attackY=-1}),mapSprite.on("click",e=>{if(isPlaying)return;const t=stage.mouseX-MARGIN_X,i=stage.mouseY-MARGIN_Y,s=Math.floor(t/CELL_SIZE),a=Math.floor(i/CELL_SIZE);if(s>=0&&s<mapSizeX&&a>=0&&a<mapSizeY){console.log(`クリックした場所 = (${s}, ${a})`),console.log(`選択中の間引きレート = ${selectMabikiRatio}%`);let e=!1;for(let t=0;t<mabikiCells.length;t+=1){const i=mabikiCells[t];if(s===i.x&&a===i.y){e=!0,0===selectMabikiRatio?mabikiCells.splice(t,1):i.ratio=selectMabikiRatio;break}}e||0!==selectMabikiRatio&&mabikiCells.push({x:s,y:a,ratio:selectMabikiRatio}),console.log("現在の間引きセル = %o",mabikiCells),drawMap(),save()}else console.log(`クリックした場所 = (${s}, ${a})`),console.error("マップ外です")});const t=document.createElement("style");let i="";for(let e=0;e<=100;e+=10){i+=`.mabiki-${e}{background:${COLOR_MABIKI.replace("alpha",e/100)};}`}t.innerHTML=i,document.head.appendChild(t),debugs={},["info-left-seconds","info-pop-golden-egg-counts","info-golden-egg-counts","info-salmonid-counts","info-pop-salmonid-counts","info-lost-salmonid-counts","info-aki","info-manseki"].forEach(e=>{debugs[e]=document.getElementById(e)}),SPAWN_POINTS.forEach(e=>{getRouteMap(e.x,e.y)})}window.addEventListener("load",()=>{initialize()});